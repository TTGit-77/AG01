{% extends 'admin_base.html' %}

{% block content %}
<h2 class="mb-4">Admin Dashboard</h2>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Users</h5>
                <h3>{{ total_users }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Total Bookings</h5>
                <h3>{{ total_bookings }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Total Movies</h5>
                <h3>{{ movies|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">Revenue</h5>
                <h3>₹{{ total_revenue }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-semibold text-white" id="movies-tab" data-bs-toggle="tab" data-bs-target="#movies" type="button" role="tab" style="background:linear-gradient(90deg,#1a2980,#26d0ce);border:none;">
            <i class="fas fa-film me-2"></i>Movies
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-semibold" id="theatres-tab" data-bs-toggle="tab" data-bs-target="#theatres" type="button" role="tab">
            <i class="fas fa-building me-2"></i>Theatres
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-semibold" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Users
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-semibold" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">
            <i class="fas fa-ticket-alt me-2"></i>Bookings
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabContent">
    <!-- Movies Tab -->
    <div class="tab-pane fade show active" id="movies" role="tabpanel">
        <div class="mb-3 text-end">
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addMovieModal">+ Add Movie</button>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead style="background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;">
                    <tr>
                        <th>Poster</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Director</th>
                        <th>Rating</th>
                        <th>Showtimes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for movie in movies %}
                    <tr>
                        <td><img src="{{ movie.poster_url }}" alt="{{ movie.title }}" style="height:60px;border-radius:6px;"></td>
                        <td>{{ movie.title }}</td>
                        <td>{{ movie.genre }}</td>
                        <td>{{ movie.release_year }}</td>
                        <td>{{ movie.director }}</td>
                        <td><span class="badge bg-success">★ {{ movie.rating }}</span></td>
                        <td><a href="{{ url_for('admin_manage_showtimes', movie_id=movie.id) }}" class="btn btn-sm btn-info">Manage Showtimes</a></td>
                        <td>
                            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editMovieModal{{ movie.id }}">Edit</button>
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteMovieModal{{ movie.id }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Theatres Tab -->
    <div class="tab-pane fade" id="theatres" role="tabpanel">
        <div class="mb-3 text-end">
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTheatreModal">+ Add Theatre</button>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead style="background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;">
                    <tr>
                        <th>ID</th>
                        <th>Theatre Name</th>
                        <th>Owner</th>
                        <th>Location</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Screens</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for theatre in theatres %}
                    <tr>
                        <td>{{ theatre.id }}</td>
                        <td class="fw-semibold">{{ theatre.name }}</td>
                        <td>{{ theatre.owner_name }}</td>
                        <td>{{ theatre.location }}</td>
                        <td>{{ theatre.email }}</td>
                        <td>{{ theatre.phone }}</td>
                        <td><span class="badge bg-info">{{ theatre.total_screens }}</span></td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_theatre', theatre_id=theatre.id) }}" 
                                  style="display: inline;" onsubmit="return confirm('Delete this theatre and all its data?')">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead style="background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;">
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Total Bookings</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.username or 'N/A' }}</td>
                        <td>
                            {% set user_bookings = user.id | string %}
                            <span class="badge bg-info">{{ user.bookings | length if user.bookings else 0 }}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="alert('User ID: {{ user.id }}')">View Details</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bookings Tab -->
    <div class="tab-pane fade" id="bookings" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead style="background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;">
                    <tr>
                        <th>Booking ID</th>
                        <th>User Email</th>
                        <th>Movie</th>
                        <th>Show Date</th>
                        <th>Show Time</th>
                        <th>Seats</th>
                        <th>Booking Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td>{{ booking.id }}</td>
                        <td>{{ booking.user.email if booking.user else 'N/A' }}</td>
                        <td>{{ booking.showtime.movie.title if booking.showtime and booking.showtime.movie else 'N/A' }}</td>
                        <td>{{ booking.showtime.show_date if booking.showtime else 'N/A' }}</td>
                        <td>{{ booking.showtime.show_time if booking.showtime else 'N/A' }}</td>
                        <td><span class="badge bg-primary">{{ booking.seats }}</span></td>
                        <td>{{ booking.booking_time.strftime('%Y-%m-%d %H:%M') if booking.booking_time else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Add Movie Modal -->
<div class="modal fade" id="addMovieModal" tabindex="-1" aria-labelledby="addMovieModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <form method="POST" action="{{ url_for('admin_add_movie') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="addMovieModalLabel">Add New Movie</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Director</label>
            <input type="text" class="form-control" name="director" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Release Year</label>
            <input type="number" class="form-control" name="release_year" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Genre</label>
            <input type="text" class="form-control" name="genre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <input type="number" step="0.1" min="0" max="10" class="form-control" name="rating" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Poster URL</label>
            <input type="url" class="form-control" name="poster_url" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-gradient">Add Movie</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Theatre Modal -->
<div class="modal fade" id="addTheatreModal" tabindex="-1" aria-labelledby="addTheatreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <form method="POST" action="{{ url_for('admin_add_theatre') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="addTheatreModalLabel">Add New Theatre</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Theatre Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Owner Name</label>
              <input type="text" class="form-control" name="owner_name" required>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" name="location" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="phone" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="password" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Screens</label>
              <input type="number" class="form-control" name="total_screens" min="1" max="10" value="3" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-gradient">Add Theatre</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Movie Modals -->
{% for movie in movies %}
<!-- Edit Movie Modal -->
<div class="modal fade" id="editMovieModal{{ movie.id }}" tabindex="-1" aria-labelledby="editMovieModalLabel{{ movie.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <form method="POST" action="{{ url_for('admin_edit_movie', movie_id=movie.id) }}">
        <div class="modal-header">
          <h5 class="modal-title" id="editMovieModalLabel{{ movie.id }}">Edit Movie</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" name="title" value="{{ movie.title }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Director</label>
            <input type="text" class="form-control" name="director" value="{{ movie.director }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Release Year</label>
            <input type="number" class="form-control" name="release_year" value="{{ movie.release_year }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Genre</label>
            <input type="text" class="form-control" name="genre" value="{{ movie.genre }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <input type="number" step="0.1" min="0" max="10" class="form-control" name="rating" value="{{ movie.rating }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Poster URL</label>
            <input type="url" class="form-control" name="poster_url" value="{{ movie.poster_url }}" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-gradient">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Movie Modal -->
<div class="modal fade" id="deleteMovieModal{{ movie.id }}" tabindex="-1" aria-labelledby="deleteMovieModalLabel{{ movie.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteMovieModalLabel{{ movie.id }}">Delete Movie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "{{ movie.title }}"? This will also delete all associated showtimes and bookings.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('admin_delete_movie', movie_id=movie.id) }}" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
